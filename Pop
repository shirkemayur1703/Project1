// ChatUI.jsx
import { useState, useRef, useEffect } from "react";
import { ChevronDown } from "lucide-react";
import MyVarPopup from "./MyVarPopup";

export default function ChatUI() {
  const [isMyVarPopupOpen, setIsMyVarPopupOpen] = useState(false);
  const iconRef = useRef(null);

  return (
    <div className="w-full h-screen flex justify-center items-center relative">

      {/* Chat Input Box */}
      <div className="flex items-center gap-2 w-[500px] p-3 border rounded-lg shadow-sm bg-white">
        <input
          type="text"
          placeholder="Ask something..."
          className="flex-1 outline-none"
        />

        {/* MyVar trigger icon */}
        <button
          ref={iconRef}
          onClick={() => setIsMyVarPopupOpen(!isMyVarPopupOpen)}
          className="p-2 rounded hover:bg-gray-200"
        >
          <ChevronDown />
        </button>

        <button className="px-3 py-1 bg-blue-600 text-white rounded-md">
          Send
        </button>
      </div>

      {/* Popup */}
      {isMyVarPopupOpen && (
        <MyVarPopup
          onClose={() => setIsMyVarPopupOpen(false)}
          iconRef={iconRef}
        />
      )}
    </div>
  );
}


// MyVarPopup.jsx
import { useEffect, useRef, useState } from "react";
import { X, CheckCircle2 } from "lucide-react";

export default function MyVarPopup({ onClose, iconRef }) {
  const popupRef = useRef(null);
  const [position, setPosition] = useState({ top: 0, left: 0 });

  const [myVarAllChecked, setMyVarAllChecked] = useState(false);
  const [myVarList, setMyVarList] = useState([
    { id: 1, name: "Item A", status: "active", checked: false },
    { id: 2, name: "Item B", status: "inactive", checked: false },
    { id: 3, name: "Item C", status: "active", checked: false },
    { id: 4, name: "Item D", status: "inactive", checked: false },
  ]);

  // Position popup exactly under the icon
  useEffect(() => {
    if (iconRef.current) {
      const rect = iconRef.current.getBoundingClientRect();
      setPosition({
        top: rect.bottom + 8, // 8px spacing
        left: rect.left - 280, // Adjust popup horizontal alignment
      });
    }
  }, [iconRef]);

  // Close when clicking outside
  useEffect(() => {
    function handleClickOutside(e) {
      if (
        popupRef.current &&
        !popupRef.current.contains(e.target) &&
        !iconRef.current.contains(e.target)
      ) {
        onClose();
      }
    }
    document.addEventListener("mousedown", handleClickOutside);
    return () => document.removeEventListener("mousedown", handleClickOutside);
  }, [onClose, iconRef]);

  // Toggle select all
  const toggleMyVarAll = () => {
    const newVal = !myVarAllChecked;
    setMyVarAllChecked(newVal);
    setMyVarList(myVarList.map((x) => ({ ...x, checked: newVal })));
  };

  // Toggle single item
  const toggleMyVar = (id) => {
    const updated = myVarList.map((item) =>
      item.id === id ? { ...item, checked: !item.checked } : item
    );
    setMyVarList(updated);
    setMyVarAllChecked(updated.every((x) => x.checked));
  };

  return (
    <div
      ref={popupRef}
      className="absolute bg-white shadow-lg rounded-lg border w-[360px] p-3 z-50"
      style={{ top: position.top, left: position.left }}
    >
      {/* Arrow pointer */}
      <div className="absolute -top-2 right-6 w-3 h-3 bg-white rotate-45 border-l border-t"></div>

      {/* Header */}
      <div className="flex justify-between items-center mb-2">
        <h2 className="font-semibold">Choose Items</h2>
        <button onClick={onClose}>
          <X size={18} />
        </button>
      </div>

      {/* Table */}
      <table className="w-full">
        <thead>
          <tr className="text-left border-b">
            <th className="p-2">
              <input
                type="checkbox"
                checked={myVarAllChecked}
                onChange={toggleMyVarAll}
              />
            </th>
            <th className="p-2">Status</th>
            <th className="p-2">Name</th>
          </tr>
        </thead>

        <tbody>
          {myVarList.map((item) => (
            <tr key={item.id} className="border-b last:border-none hover:bg-gray-50">
              <td className="p-2">
                <input
                  type="checkbox"
                  checked={item.checked}
                  onChange={() => toggleMyVar(item.id)}
                />
              </td>

              <td className="p-2">
                {item.status === "active" ? (
                  <CheckCircle2 className="text-green-600" size={18} />
                ) : (
                  <X className="text-red-500" size={18} />
                )}
              </td>

              <td className="p-2">{item.name}</td>
            </tr>
          ))}
        </tbody>
      </table>

      {/* Buttons */}
      <div className="flex justify-end gap-3 mt-4">
        <button
          className="px-3 py-1 border rounded hover:bg-gray-100"
          onClick={onClose}
        >
          Cancel
        </button>
        <button className="px-3 py-1 bg-blue-600 text-white rounded">
          Done
        </button>
      </div>
    </div>
  );
}
